# OCR Image Loader Tests

This directory contains comprehensive tests for the `OcrImageLoader` class.

## Test Files

### test_ocr_image_loader.py
Unit tests with **full mocking** of PaddleOCR and all dependencies. These tests run fast and verify the loader's logic without requiring PaddleOCR installation.

### test_ocr_image_loader_real.py (**NEW**)
Integration tests using **real OCR processing** with actual PaddleOCR execution. These tests:
- Process the real `example.png` test image
- Verify actual text extraction accuracy
- Validate bounding box normalization
- Test confidence score handling
- Verify output format correctness

## Running the Tests

### Quick Unit Tests (Mocked)
```bash
pytest cognee/tests/unit/loaders/test_ocr_image_loader.py -v
```

### Real OCR Tests (Requires PaddleOCR)
```bash
# Install OCR dependencies first
pip install cognee[ocr]

# Run real OCR tests
pytest cognee/tests/unit/loaders/test_ocr_image_loader_real.py -v
```

**Note**: Real OCR tests will automatically skip if PaddleOCR is not installed.

## Supported PaddleOCR Versions

The OcrImageLoader supports both PaddleOCR 2.x and 3.x:
- **PaddleOCR 3.x**: Uses `device` parameter (recommended)
- **PaddleOCR 2.x**: Uses legacy `use_gpu` parameter (backward compatible)

The adapter automatically detects the version and uses the correct API.

## Test Structure

### TestRealOCRProcessing
- `test_process_example_png_success()` - Verify successful OCR processing
- `test_ocr_extracts_actual_text()` - Validate text extraction with keyword matching
- `test_bbox_coordinates_normalized()` - Ensure bboxes are in 0-1 range

### TestOCROutputQuality
- `test_confidence_scores_present_and_valid()` - Validate confidence scores
- `test_bbox_dimensions_reasonable()` - Check bbox sizes are reasonable
- `test_text_ordering_logical()` - Verify reading order (top-to-bottom, left-to-right)

### TestOCRConfiguration
- `test_low_confidence_threshold()` - Test with min_confidence=0.3
- `test_high_confidence_threshold()` - Test with min_confidence=0.9

### TestEdgeCases
- `test_blank_white_image()` - Handle blank images
- `test_very_small_image()` - Handle 10x10 pixel images

### TestFallbackBehavior
- `test_empty_ocr_result_triggers_fallback()` - Verify fallback to ImageLoader

### TestOutputFormatValidation
- `test_output_format_matches_expected()` - Validate format structure
- `test_page_number_always_one_for_images()` - Images are single-page
- `test_output_format_consistency_with_pdf_loader()` - Match OcrPdfLoader format

### TestPaddleOCRUnavailable
- `test_fallback_when_paddleocr_unavailable()` - Behavior without PaddleOCR installed

## Test Data

- `cognee/tests/test_data/example.png` - Real 683Ã—384 PNG with text about programmers and light bulbs
- Synthetic images generated by fixtures for edge cases

## Expected Output Format

```
text [page=1, bbox=(0.100,0.200,0.800,0.900), type=text, confidence=0.950]
```

Where:
- `page=1` - Always 1 for images (single-page)
- `bbox=(x_min,y_min,x_max,y_max)` - Normalized coordinates (0-1 range)
- `type=text` - Element type
- `confidence=0.950` - OCR confidence score (0-1 range)

## Debugging

If tests fail or hang:

1. **Check PaddleOCR installation**:
   ```bash
   python -c "from cognee.infrastructure.ocr import is_paddleocr_available; print(is_paddleocr_available())"
   ```

2. **Check PaddleOCR version**:
   ```bash
   python -c "import paddleocr; print(paddleocr.__version__)"
   ```

3. **Run single test with verbose output**:
   ```bash
   pytest cognee/tests/unit/loaders/test_ocr_image_loader_real.py::TestRealOCRProcessing::test_process_example_png_success -v -s
   ```

4. **Increase timeout** (PaddleOCR initialization can take 10-30 seconds):
   ```bash
   pytest cognee/tests/unit/loaders/test_ocr_image_loader_real.py --timeout=120
   ```

## Benefits of Real OCR Tests

1. **Catch Integration Issues**: Discovered `use_gpu` parameter incompatibility
2. **Verify Actual Functionality**: Ensures text is really extracted, not just mocked
3. **Validate Normalization**: Confirms bbox coordinates are correctly normalized
4. **Test Real Performance**: Identifies slow operations or timeout issues
5. **Format Verification**: Ensures output format matches expectations across real data

## Contributing

When adding new features to `OcrImageLoader`:

1. Add unit tests to `test_ocr_image_loader.py` (mocked, fast)
2. Add integration tests to `test_ocr_image_loader_real.py` (real OCR, comprehensive)
3. Update this README with new test information
